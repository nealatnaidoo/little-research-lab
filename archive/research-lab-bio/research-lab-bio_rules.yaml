# research-lab-bio_rules.yaml

```yaml
project:
  slug: research-lab-bio
  rules_version: "1.0"
  required_sections:
    - security
    - auth
    - rbac
    - abac
    - content
    - blocks
    - uploads
    - embeds
    - scheduling
    - rate_limits
    - ops

security:
  fail_fast_on_invalid_rules: true
  allowed_link_protocols: ["https", "mailto"]
  disallowed_markdown_features:
    - raw_html
    - script_tags
  csrf:
    enabled: true
    mode: "token"   # token stored server-side and validated on mutation actions

auth:
  password_hashing:
    algorithm: "argon2"   # adapter may implement bcrypt if argon2 unavailable
    min_length: 12
  sessions:
    ttl_minutes: 10080   # 7 days
    rotate_on_login: true
    store_tokens_hashed: true
    cookie:
      secure: true
      http_only: true
      same_site: "Lax"

rbac:
  roles:
    owner:
      - "*"
    admin:
      - "settings:*"
      - "users:*"
      - "content:*"
      - "links:*"
      - "assets:*"
      - "publish:*"
      - "schedule:*"
      - "audit:read"
    publisher:
      - "content:create"
      - "content:edit"
      - "content:view_drafts"
      - "assets:upload"
      - "assets:read"
      - "publish:now"
      - "publish:schedule"
      - "schedule:view"
    editor:
      - "content:create"
      - "content:edit_own"
      - "content:view_drafts_own"
      - "assets:upload"
      - "assets:read"
      - "schedule:view_own"
    viewer:
      - "content:view_drafts"
      - "assets:read"
  public_permissions:
    - "content:read_published"
    - "links:read_public"
    - "assets:read_public"

abac:
  content_edit_rules:
    - if: { role_in: ["owner", "admin"] }
      allow: ["content:*"]
    - if: { role_in: ["publisher"] }
      allow: ["content:edit", "content:create", "publish:*", "schedule:*"]
    - if: { role_in: ["editor"] , owns_content: true }
      allow: ["content:edit_own", "content:view_drafts_own", "schedule:view_own"]
    - if: { collaborator_scope_in: ["edit"] }
      allow: ["content:edit"]
    - if: { collaborator_scope_in: ["view"] }
      allow: ["content:view_drafts"]
  asset_read_rules:
    - if: { role_in: ["owner", "admin"] }
      allow: ["assets:*"]
    - if: { role_in: ["publisher", "editor", "viewer"] }
      allow: ["assets:read"]
    - if: { public_request: true, asset_visibility_in: ["public"] }
      allow: ["assets:read_public"]
    - if: { public_request: true, referenced_by_published_public_content: true }
      allow: ["assets:read_public"]

content:
  slug:
    pattern: "^[a-z0-9]+(?:-[a-z0-9]+)*$"
    min: 3
    max: 80
  title:
    min: 3
    max: 140
  summary:
    max: 280
  visibility_values: ["public", "unlisted", "private"]
  status_values: ["draft", "scheduled", "published", "archived"]

blocks:
  allowed_types: ["markdown", "image", "chart", "embed", "divider"]
  max_blocks_per_item: 200
  schemas:
    markdown:
      required: ["text"]
      properties:
        text: { type: "string", min: 1, max: 50000 }
    image:
      required: ["asset_id"]
      properties:
        asset_id: { type: "uuid" }
        caption: { type: "string", max: 300 }
        max_width_px: { type: "int", min: 200, max: 1600 }
    chart:
      required: ["spec"]
      properties:
        spec: { type: "object", max_bytes: 20000 }
        width_px: { type: "int", min: 300, max: 1600 }
        height_px: { type: "int", min: 200, max: 1200 }
        dpi: { type: "int", min: 72, max: 200 }
    embed:
      required: ["url"]
      properties:
        url: { type: "string", min: 8, max: 500 }
        title: { type: "string", max: 140 }
    divider:
      required: []
      properties: {}

uploads:
  max_upload_bytes: 10485760   # 10 MB
  allowlist_mime_types:
    - "image/png"
    - "image/jpeg"
    - "image/webp"
    - "image/svg+xml"
    - "application/pdf"
  allowlist_extensions:
    - ".png"
    - ".jpg"
    - ".jpeg"
    - ".webp"
    - ".svg"
    - ".pdf"
  quarantine:
    enabled: false   # future: integrate AV scan

embeds:
  allowlist:
    - provider: "youtube"
      match: "^https://(www\\.)?youtube\\.com/.*|^https://youtu\\.be/.*"
    - provider: "github"
      match: "^https://(www\\.)?github\\.com/.*"
    - provider: "observable"
      match: "^https://(www\\.)?observablehq\\.com/.*"
  deny_if_not_allowlisted: true

scheduling:
  publish_check_mode: ["on_startup", "on_access", "cli_job"]
  max_scheduled_days_ahead: 365
  allow_backdate_publish_at: false

rate_limits:
  login:
    window_seconds: 300
    max_attempts: 10
  upload:
    window_seconds: 300
    max_requests: 30

ops:
  data_dir_required: true
  required_env:
    - "LAB_SECRET_KEY"
    - "LAB_DATA_DIR"
    - "LAB_BASE_URL"
  bootstrap_admin:
    enabled_if_no_users: true
    required_env_when_enabled:
      - "LAB_ADMIN_BOOTSTRAP_EMAIL"
      - "LAB_ADMIN_BOOTSTRAP_PASSWORD"
  backups:
    include:
      - "db"
      - "assets"
    backup_dir_name: "backups"
    retention_count: 14
```
