# little-research-lab-v3_rules.yaml
schema_version: 1
project_slug: "little-research-lab-v3"

required_sections:
  - security
  - auth
  - routing
  - content
  - assets
  - scheduler
  - analytics
  - redirects
  - observability
  - feature_flags
  - env

security:
  deny_by_default: true
  session:
    cookie:
      http_only: true
      secure: true
      same_site: "Lax"
      max_age_seconds: 1209600
    csrf:
      enabled: true
      header_name: "X-CSRF-Token"
  headers:
    x_content_type_options: "nosniff"
    x_frame_options: "SAMEORIGIN"
    referrer_policy: "strict-origin-when-cross-origin"
    content_security_policy:
      enabled: true
      directives:
        default_src: ["'self'"]
        script_src: ["'self'"]
        style_src: ["'self'", "'unsafe-inline'"]
        img_src: ["'self'", "data:"]
        connect_src: ["'self'"]
        frame_src: ["'self'"]
        object_src: ["'none'"]
        base_uri: ["'self'"]
        form_action: ["'self'"]

auth:
  roles: ["admin", "public"]
  admin_only_routes_prefixes: ["/admin", "/api/admin"]
  rate_limits:
    login: { window_seconds: 300, max_requests: 20, block_seconds: 900 }
    admin_api: { window_seconds: 60, max_requests: 300 }
  lockout:
    enabled: true
    max_failed_attempts: 10
    window_seconds: 900
    lock_seconds: 1800

routing:
  timezone_display: "Europe/London"
  namespaces:
    posts_prefix: "/p"
    resources_prefix: "/r"
  slug_uniqueness: "global"
  canonical_base_url_required: true
  public_visibility:
    only_status: "published"
    exclude_from_sitemap_statuses: ["draft", "scheduled"]
  cache:
    public_ssr_ttl_seconds: 300
    settings_cache_ttl_seconds: 60

content:
  types: ["post", "resource_pdf"]
  status_machine:
    draft: { can_transition_to: ["scheduled", "published"] }
    scheduled: { can_transition_to: ["draft", "published"] }
    published: { can_transition_to: ["draft"] }
  publish_guards:
    require_validated_content: true
    block_publish_if_missing_assets: true
  rich_text:
    canonical_storage: "rich_text_json_plus_derived_blocks"
    max_json_bytes: 400000
    sanitizer:
      allow_tags: [p, h1, h2, h3, blockquote, ul, ol, li, strong, em, code, pre, a, img]
      allow_attrs:
        a: [href, title]
        img: [src, alt, title, width, height]
      link_rel:
        add_noopener: true
        add_noreferrer: true
        add_ugc: false
      forbid_protocols: ["javascript:", "data:"]
      max_links_per_doc: 500
    images:
      inline_upload:
        enabled: true
        require_asset_reference: true

assets:
  kinds:
    image:
      allowed_mime_types: ["image/jpeg", "image/png", "image/webp", "image/gif"]
      max_upload_bytes: 10000000
    pdf:
      allowed_mime_types: ["application/pdf"]
      max_upload_bytes: 50000000
  versioning:
    immutable_versions: true
    latest_alias_enabled: true
    latest_behavior: "302_to_versioned"
  serving:
    cache_control:
      versioned: "public, max-age=31536000, immutable"
      latest: "public, max-age=60"
    etag:
      source: "sha256"
    content_disposition:
      default: "inline"
      download_query_param: "download"
      download_value: "1"
      download_disposition: "attachment"
    integrity_header_name: "X-Content-SHA256"
    range_requests:
      enabled: true
  storage:
    require_immutable_keys: true

scheduler:
  idempotency:
    key: ["content_id", "publish_at_utc"]
    unique_constraint_required: true
  timing:
    never_publish_early: true
    publish_grace_seconds: 120
    display_tz: "Europe/London"
  retries:
    max_attempts: 10
    backoff_seconds: [5, 15, 60, 300, 900, 1800]
  dst_tests_required: true

analytics:
  modes: ["off", "basic", "attribution"]
  default_mode: "basic"
  ingestion:
    endpoint_path: "/a/event"
    method: "POST"
    rate_limit:
      window_seconds: 60
      max_requests: 600
    schema:
      allowed_event_types: ["page_view", "outbound_click", "asset_download"]
      allowed_fields:
        - event_type
        - ts
        - path
        - content_id
        - link_id
        - asset_id
        - asset_version_id
        - referrer
        - utm_source
        - utm_medium
        - utm_campaign
        - utm_content
        - utm_term
        - ua_class
      forbidden_fields: [ip, ip_address, user_agent, ua_raw, cookie, cookie_id, visitor_id, email]
    bot_classification:
      ua_classes: ["bot", "real", "unknown"]
      treat_unknown_as: "real"
      exclude_bots_from_real_counts: true
    dedupe:
      enabled: true
      ttl_seconds: 10
  aggregation:
    buckets: ["minute", "hour", "day"]
    default_bucket: "day"
    keep_aggregates_forever: true
  privacy:
    store_raw_events: false
    store_ip: false
    store_full_user_agent: false
    store_cookies: false
    store_visitor_identifiers: false

redirects:
  enabled: true
  status_code: 301
  constraints:
    require_internal_targets: true
    allow_external_targets: false
    max_chain_length: 3
    prevent_loops: true
    prevent_collisions_with_routes: true
  preserve_query_params:
    utm_params: true

observability:
  logs:
    format: "json"
    pii_allowed: false
  metrics:
    enabled: true
  health:
    web_path: "/healthz"
    worker_path: "/healthz/worker"

feature_flags:
  outbound_click_redirector: true
  rss_enabled: false
  sitemap_enabled: true

env:
  required: ["BASE_URL", "SESSION_SECRET", "DATABASE_URL", "STORAGE_BACKEND"]
  optional: ["ANALYTICS_MODE", "SENTRY_DSN", "FLY_APP_NAME"]
